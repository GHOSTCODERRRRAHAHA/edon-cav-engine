"""gRPC transport implementation for EDON SDK."""

from typing import Dict, Any, Iterator
from pathlib import Path
import sys

from .transport import Transport
from .exceptions import EdonError, EdonConnectionError


class GRPCTransport(Transport):
    """gRPC transport implementation."""
    
    def __init__(self, host: str = "localhost", port: int = 50051):
        try:
            import grpc
        except ImportError as e:
            raise ImportError(
                f"gRPC dependencies not installed: {e}. "
                f"Install with: pip install grpcio grpcio-tools"
            ) from e
        
        # Try to find generated protobuf files
        # Look in integrations/grpc/edon_grpc_service relative to project root
        current_file = Path(__file__).resolve()
        # SDK is in sdk/python/edon/, so go up 3 levels to project root
        project_root = current_file.parent.parent.parent.parent
        grpc_path = project_root / "integrations" / "grpc" / "edon_grpc_service"
        
        if not (grpc_path / "edon_pb2.py").exists():
            raise ImportError(
                f"Protobuf files not found at {grpc_path}. "
                f"Run: cd integrations/grpc/edon_grpc_service && python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. edon.proto"
            )
        
        # Add to path and import
        if str(grpc_path) not in sys.path:
            sys.path.insert(0, str(grpc_path))
        
        try:
            import edon_pb2
            import edon_pb2_grpc
        except ImportError as e:
            raise ImportError(
                f"Failed to import protobuf generated code: {e}. "
                f"Ensure protobuf files are generated."
            ) from e
        
        self.edon_pb2 = edon_pb2
        self.edon_pb2_grpc = edon_pb2_grpc
        
        try:
            self.channel = grpc.insecure_channel(f"{host}:{port}")
            self.stub = self.edon_pb2_grpc.EdonServiceStub(self.channel)
            self.host = host
            self.port = port
        except Exception as e:
            raise EdonConnectionError(f"Failed to create gRPC channel: {e}") from e
    
    def _window_to_request(self, window: Dict[str, Any]) -> Any:
        """Convert window dict to protobuf request."""
        req = self.edon_pb2.CavRequest()
        req.eda[:] = window.get("EDA", [])
        req.temp[:] = window.get("TEMP", [])
        req.bvp[:] = window.get("BVP", [])
        req.acc_x[:] = window.get("ACC_x", [])
        req.acc_y[:] = window.get("ACC_y", [])
        req.acc_z[:] = window.get("ACC_z", [])
        req.temp_c = window.get("temp_c", 0.0)
        req.humidity = window.get("humidity", 0.0)
        req.aqi = window.get("aqi", 0)
        req.local_hour = window.get("local_hour", 12)
        return req
    
    def _response_to_dict(self, resp: Any) -> Dict[str, Any]:
        """Convert protobuf response to dict."""
        return {
            "cav_raw": resp.cav_raw,
            "cav_smooth": resp.cav_smooth,
            "state": resp.state,
            "parts": {
                "bio": resp.parts.bio,
                "env": resp.parts.env,
                "circadian": resp.parts.circadian,
                "p_stress": resp.parts.p_stress,
            },
            "controls": {
                "speed": resp.controls.speed,
                "torque": resp.controls.torque,
                "safety": resp.controls.safety,
            },
            "timestamp_ms": resp.timestamp_ms,
        }
    
    def compute_cav(self, window: Dict[str, Any]) -> Dict[str, Any]:
        """Compute CAV via gRPC."""
        try:
            req = self._window_to_request(window)
            resp = self.stub.GetState(req)
            return self._response_to_dict(resp)
        except Exception as e:
            raise EdonError(f"gRPC CAV computation failed: {str(e)}") from e
    
    def stream(self, window: Dict[str, Any]) -> Iterator[Dict[str, Any]]:
        """Stream CAV updates via gRPC."""
        try:
            # Create StateStreamRequest for streaming
            req = self.edon_pb2.StateStreamRequest()
            req.eda[:] = window.get("EDA", [])
            req.temp[:] = window.get("TEMP", [])
            req.bvp[:] = window.get("BVP", [])
            req.acc_x[:] = window.get("ACC_x", [])
            req.acc_y[:] = window.get("ACC_y", [])
            req.acc_z[:] = window.get("ACC_z", [])
            req.temp_c = window.get("temp_c", 0.0)
            req.humidity = window.get("humidity", 0.0)
            req.aqi = window.get("aqi", 0)
            req.local_hour = window.get("local_hour", 12)
            req.stream_mode = True
            
            for resp in self.stub.StreamState(req):
                yield self._response_to_dict(resp)
        except Exception as e:
            raise EdonError(f"gRPC streaming failed: {str(e)}") from e
    
    def health(self) -> Dict[str, Any]:
        """Check health via gRPC (simple ping)."""
        try:
            # Create a minimal valid request
            req = self.edon_pb2.CavRequest()
            req.eda[:] = [0.0] * 240
            req.temp[:] = [0.0] * 240
            req.bvp[:] = [0.0] * 240
            req.acc_x[:] = [0.0] * 240
            req.acc_y[:] = [0.0] * 240
            req.acc_z[:] = [0.0] * 240
            req.temp_c = 22.0
            req.humidity = 50.0
            req.aqi = 50
            req.local_hour = 12
            
            self.stub.GetState(req, timeout=2.0)
            return {"ok": True, "transport": "grpc"}
        except Exception as e:
            return {"ok": False, "error": str(e), "transport": "grpc"}
    
    def close(self):
        """Close gRPC channel."""
        if hasattr(self, 'channel'):
            self.channel.close()

